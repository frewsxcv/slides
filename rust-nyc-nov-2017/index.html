<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
      @import url('https://fonts.googleapis.com/css?family=Droid+Sans|Droid+Serif|Inconsolata');

      body {
        font-family: 'Droid Serif';
      }

      h1, h2, h3, h4, h5, h6 {
        font-family: 'Droid Sans';
        font-weight: normal;
      }

      .remark-code, .remark-inline-code {
        font-family: 'Inconsolata';
      }

      .footnote {
        font-size: 0.8em;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# building a threadpool in N minutes

???

https://github.com/Kimundi/scoped-threadpool-rs/blob/master/src/lib.rs

kimundi.github.io/scoped-threadpool-rs/scoped_threadpool/struct.Scope.html

https://doc.servo.org/src/rayon_core/thread_pool/mod.rs.html#47-49

---

class: center, middle

# who

## corey farwell / rwell.org / frewsxcv

---

# Agenda

1. Introduction
2. Deep-dive
3. ...

---

# Introduction

---

<img src="https://i.imgur.com/6Y0CvYm.png" alt="" style="width: 100%; border: 1px black solid;">

.footnote[https://www.rust-lang.org/en-US/faq.html]

---

```rust
extern crate image;

use image::GenericImage;
use std::path::Path;

const GRID: [(u32, u32, i32); 9] = [
    (0, 0, 180), (0, 1, 60), (0, 2, 300),
    (1, 0, 340), (1, 1, 20), (1, 2, 220),
    (2, 0, 260), (2, 1, 100), (2, 2, 140)
];

fn warholify(src_path: &Path) {
    let img = match image::open(src_path) {
        Ok(i) => i,
        Err(..) => return,
    };
    let (src_width, src_height) = img.dimensions();
    let mut img_buf = image::ImageBuffer::new(src_width * 3, src_height * 3);
    for &(x, y, hue) in GRID.iter() {
        img_buf.copy_from(
            &img.adjust_contrast(100.).huerotate(hue),
            src_width * x,
            src_height * y,
        );
    }
    let dst_path = Path::new("out").join(src_path);
    img_buf.save(dst_path).unwrap();
}
```

---

```rust
for dir_entry in std::fs::read_dir("dogs")? {
    warholify(dir_entry?.path())
}

println!("done! 🐶");
```

---

```rust
let mut handles = vec![];

for dir_entry in std::fs::read_dir("dogs")? {
    let handle = std::thread::spawn(|| {
        warholify(dir_entry?.path())
    })?;

    handles.push(handle);
});

handles.for_each(|handle| {
    handle.join().unwrap();
})
```

---

Demonstrate usability issues of scopeless threadpool

---

Show how to accomplish scopeless threadpool issues with barrier

---

Show scoped

https://github.com/reem/rust-scoped-pool/blob/master/src/lib.rs

https://github.com/rust-lang/rust/blob/d754722a04b99fdcae0fd97fa2a4395521145ef2/src/libstd/sync/task_pool.rs

https://github.com/servo/servo/blob/612f2c1c2a9e56de2abe9ce32fcb6461a133686d/components/style/scoped_tls.rs

---



---

```rust
/// Returns a handle to the global thread pool. This is the pool
/// that Rayon will use by default when you perform a `join()` or
/// `scope()` operation, if no other thread-pool is installed. If
/// no global thread-pool has yet been started when this function
/// is called, then the global thread-pool will be created (with
/// the default configuration). If you wish to configure the
/// global thread-pool differently, then you can use [the
/// `rayon::initialize()` function][f] to do so.
///
/// [f]: fn.initialize.html
pub fn global() -> &'static Arc<ThreadPool> {
    lazy_static! {
        static ref DEFAULT_THREAD_POOL: Arc<ThreadPool> =
            Arc::new(ThreadPool { registry: Registry::global() });
    }

    &DEFAULT_THREAD_POOL
}
```

.footnote[https://github.com/rayon-rs/rayon/blob/master/rayon-core/src/thread_pool/mod.rs]

???

'image' crate uses rayon _and_ scoped_threadpool
    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
